<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>AriUM Scaffolding</title>
        <!-- Bootstrap styles -->
        <link href="Content/bootstrap.min.css" rel="stylesheet" media="screen" />
        <!-- Kendo styles -->
        <link href="Content/kendo/2012.3.1114/kendo.common.min.css" rel="stylesheet" />
        <link href="Content/kendo/2012.3.1114/kendo.bootstrap.min.css" rel="stylesheet" />
        <!-- Ariadna styles -->
        <link href="Content/ariadna.css" rel="stylesheet" />

        <!-- JQuery -->
        <script src="Scripts/kendo/2012.3.1114/jquery.min.js"></script>
        <!-- Bootstrap -->
        <script src="Scripts/bootstrap.min.js"></script>
        <!-- Bootbox -->
        <script src="Scripts/bootbox.js"></script>
        <!-- Kendo -->
        <script src="Scripts/kendo/2012.3.1114/kendo.web.min.js"></script>
        <script src="Scripts/kendo/2012.3.1114/cultures/kendo.culture.es-ES.min.js"></script>
        <!-- Ariadna  -->
        <script src="Scripts/ariadna/ariadna.um.js"></script>
        <script src="Scripts/ariadna/ariadna.localization.es-ES.js"></script>
        <!-- Configuration via JSON -->
        <script src="config.js"></script>
    </head>
    <body>
        <header id="cabecera">
        </header>
        <div id="cuerpo" style="min-height:400px;">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <h3>Usuarios</h3>
                    </div>
                </div>
                <div class="row-fluid">
                    <div id="grid" class="span12"></div>
                </div>
            </div>
        </div>
        <footer id="pie">
        </footer>

        <!-- Templates -->
        <script type="text/x-kendo-template" id="template_new">
            <a href="UserForm.html" class="btn btn-primary" title="Nuevo registro">
                <i class="icon-plus icon-white"></i>
            </a>
            <button class="btn btn-primary" onclick="pageController();" title="Ultimo registro creado / editado">
                <i class="icon-move icon-white"></i>
            </button>
        </script>
        <script type="tex/x-kendo-template" id="template_edit">
            <div class="pull-right">
                <button class="btn btn-primary" onclick="grid_edit(#=UserId#,'User');" title="Editar registro">
                    <i class="icon-pencil icon-white"></i>
                </button>
                <button class="btn btn-primary" onclick="grid_delete(#=UserId#,'User','#=Name#');" title="Eliminar registro">
                    <i class="icon-minus icon-white"></i>
                </button>
            </div>
        </script>
        <script type="text/javascript">
            (function ($) {
                $(document).ready(function () {
                    // templates
                    var t_new = kendo.template($("#template_new").html());
                    var t_edit = kendo.template($("#template_edit").html());
                    //
                    cargaCabeceraPie();
                    // set title
                    document.title = "Usuarios";
            
                    // remote dataSource
                    var gridDS = new kendo.data.DataSource({
                        transport: {
                            read: {
                                url: controller_url.users,
                                dataType: "json",
                                type: "GET",
                                contentType: "application/json"
                            },
                            parameterMap: function (data, type) {
                                if (type != "GET")
                                    return kendo.stringify(data);
                            }
                        },
                        schema: {
                            model: {
                                id: "UserId",
                                fields: {
                                    UserId: { type: "number", editable: false },
                                    Name: { type: "string" },
                                    Email: { type: "string" },
                                    Password: { type: "string" },
                                    UserGroup: {}
                                }
                            }
                        },
                        pageSize: 5
                    });
            
                    var gridCL = [
                        { field: "UserId", title: "ID" },
                        { field: "Name", title: "Nombre" },
                        { field: "Email", title: "Correo" },
                        { field: "UserGroup", title: "Grupo", template: "#=UserGroup?UserGroup.Name:''#"},
                        {
                            template: t_edit
                        }
                    ];
            
                    // building grid
                    $("#grid").kendoGrid({
                        dataSource: gridDS,
                        columns: gridCL,
                        toolbar: [{ text: "Nuevo registro", template: t_new }],
                        pageable: ari_pageable_es_ES,
                        sortable: true,
                        groupable: ari_groupable_es_ES,
                        filterable: ari_filterable_es_ES,
                        columnMenu: ari_columnMenu_es_ES
                    });
                });
            })(jQuery);
        </script>
        <script type="text/javascript">
            var entity;
            var id;
            function pageController() {
                // read page from url parameters
                page = gup("page");
                
                if (page != "") {
                    var pageN = parseInt(page);
                    var ds = $("#grid").data("kendoGrid").dataSource;
                    var totalPages = ds.totalPages();
                    switch (pageN) {
                        case 0:
                            ds.page(totalPages);
                            break;
                        default:
                            if (pageN <= totalPages) {
                                ds.page(pageN);
                            } else {
                                ds.page(totalPages);
                            }
                            break;
                    }
                }
            }
            function grid_edit(_id, _entitity) {
                var page = $("#grid").data("kendoGrid").dataSource.page();
                var url = "UserForm.html?UserId=" + _id + "&page=" + page;
                ari_windowOpen(url);
            }
            function grid_delete(_id, _entitity, name) {
                id = _id;
                entity = _entitity;
                bootbox.confirm("<h4>¿Desea eliminar este registro? (" + name + ")</h4>", "Cancelar", "Aceptar", deleteResponse);
            }
            function deleteResponse(arg) {
                if (arg) {
                    var url = controller_url.users + id;
                    var options = {
                        type: 'DELETE',
                        url: url,
                        dataType: 'json',
                        success: function (data, textStatus) {
                            gridRefresh();
                        }
                    };
                    $.ajax(options);
                }
            }
            function gridRefresh() {
                var grid = $("#grid").data("kendoGrid");
                grid.dataSource.read();
            }
        </script>
    </body>
</html>
