<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>AriUM Scaffolding</title>
        <!-- Bootstrap styles -->
        <link href="Content/bootstrap.min.css" rel="stylesheet" media="screen" />
        <!-- Kendo styles -->
        <link href="Content/kendo/2012.3.1114/kendo.common.min.css" rel="stylesheet" />
        <link href="Content/kendo/2012.3.1114/kendo.bootstrap.min.css" rel="stylesheet" />
        <!-- Ariadna styles -->
        <link href="Content/ariadna.css" rel="stylesheet" />

        <!-- JQuery -->
        <script src="Scripts/kendo/2012.3.1114/jquery.min.js"></script>
        <!-- Bootstrap -->
        <script src="Scripts/bootstrap.min.js"></script>
        <!-- Bootbox -->
        <script src="Scripts/bootbox.js"></script>
        <!-- Kendo -->
        <script src="Scripts/kendo/2012.3.1114/kendo.web.min.js"></script>
        <script src="Scripts/kendo/2012.3.1114/cultures/kendo.culture.es-ES.min.js"></script>
        <!-- Ariadna  -->
        <script src="Scripts/ariadna/ariadna.um.js"></script>
        <script src="Scripts/ariadna/ariadna.localization.es-ES.js"></script>
        <!-- Configuration via JSON -->
        <script src="config.js"></script>
    </head>
    <body>
        <header id="cabecera">
        </header>
        <div id="cuerpo" style="min-height:400px;">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <h3>Grupos de usuarios</h3>
                    </div>
                </div>
                <div class="row-fluid">
                    <div id="grid" class="span12"></div>
                </div>
            </div>
        </div>
        <footer id="pie">
        </footer>

        <!-- Templates -->
        <script type="text/x-kendo-template" id="template_new">
            <a href="userGroupForm.html" class="btn btn-primary" title="Nuevo registro">
                <i class="icon-plus icon-white"></i>
            </a>
            <button class="btn btn-primary" onclick="pageController();" title="Ultimo registro creado / editado">
                <i class="icon-move icon-white"></i>
            </button>
        </script>
        <script type="tex/x-kendo-template" id="template_edit">
            <div class="pull-right">
                <button class="btn btn-primary" onclick="grid_edit(#=UserGroupId#,'UserGroup');" title="Editar registro">
                    <i class="icon-pencil icon-white"></i>
                </button>
                <button class="btn btn-primary" onclick="grid_delete(#=UserGroupId#,'UserGroup','#=Name#');" title="Eliminar registro">
                    <i class="icon-minus icon-white"></i>
                </button>
            </div>
        </script>
        <script type="tex/x-kendo-template" id="template_editS">
            <div class="pull-right">
                <button class="btn btn-primary" onclick="grid_select(#=UserGroupId#,'UserGroup');" title="Seleccionar registro">
                    <i class="icon-asterisk icon-white"></i>
                </button>
                <button class="btn btn-primary" onclick="grid_edit(#=UserGroupId#,'UserGroup');" title="Editar registro">
                    <i class="icon-pencil icon-white"></i>
                </button>
                <button class="btn btn-primary" onclick="grid_delete(#=UserGroupId#,'UserGroup','#=Name#');" title="Eliminar registro">
                    <i class="icon-minus icon-white"></i>
                </button>
            </div>
        </script>
        <script type="text/javascript">
            (function ($) {
                $(document).ready(function () {
                    // templates
                    var t_new = kendo.template($("#template_new").html());
                    var t_edit = kendo.template($("#template_edit").html());
                    if (mode == "S") t_edit = kendo.template($("#template_editS").html());
                    //
                    cargaCabeceraPie();
                    // set title
                    document.title = "Grupos de usuarios";
            
                    // remote dataSource
                    var gridDS = new kendo.data.DataSource({
                        transport: {
                            read: {
                                url: controller_url.userGroups,
                                dataType: "json",
                                type: "GET",
                                contentType: "application/json"
                            },
                            parameterMap: function (data, type) {
                                if (type != "GET")
                                    return kendo.stringify(data);
                            }
                        },
                        schema: {
                            model: {
                                id: "UserGroupId",
                                fields: {
                                    UserGroupId: { type: "number", editable: false },
                                    Name: { type: "string", editable: true, nullable: true, validation: { required: true, message: { required: "Campo requerido" } } }
                                }
                            }
                        },
                        pageSize: 5
                    });
            
                    var gridCL = [
                        { field: "UserGroupId", title: "ID" },
                        { field: "Name", title: "Name" },{
                            template: t_edit
                        }
                    ];
            
                    // building grid
                    $("#grid").kendoGrid({
                        dataSource: gridDS,
                        columns: gridCL,
                        toolbar: [{ text: "Nuevo registro", template: t_new }],
                        pageable: ari_pageable_es_ES,
                        sortable: true,
                        groupable: ari_groupable_es_ES,
                        filterable: ari_filterable_es_ES,
                        columnMenu: ari_columnMenu_es_ES
                    });
                });
            })(jQuery);
        </script>
        <script type="text/javascript">
            var entity;
            var id;
            var page;
            var caller = gup("caller");
            var mode = gup("mode");
            function pageController() {
                // read page from url parameters
                page = gup("page");
                
                if (page != "") {
                    var pageN = parseInt(page);
                    var ds = $("#grid").data("kendoGrid").dataSource;
                    var totalPages = ds.totalPages();
                    switch (pageN) {
                        case 0:
                            ds.page(totalPages);
                            break;
                        default:
                            if (pageN <= totalPages) {
                                ds.page(pageN);
                            } else {
                                ds.page(totalPages);
                            }
                            break;
                    }
                }
            }
            function grid_edit(_id, _entitity) {
                var page = $("#grid").data("kendoGrid").dataSource.page();
                var url = "userGroupForm.html?UserGroupId=" + _id + "&page=" + page;
                ari_windowOpen(url);
            }
            function grid_select(_id, _entitity) {
                // the idea is to select a register a return it to
                // an external form defined by 'caller' variable (an url parameter)
                var returnUrl = "#";
                // Meaning of url parameters in return url
                // mode = R (the form is called from an external search)
                // UserGroupId = _id (the user group's selected's id)
                switch (caller) {
                    case "User":
                        returnUrl = "userForm.html?mode=R&UserGroupId=" + _id;
                        break;
                }
                ari_windowOpen(returnUrl);
            }
            function grid_delete(_id, _entitity, name) {
                id = _id;
                entity = _entitity;
                bootbox.confirm("<h4>¿Desea eliminar este registro? (" + name + ")</h4>", "Cancelar", "Aceptar", deleteResponse);
            }
            function deleteResponse(arg) {
                if (arg) {
                    var linker = ari_generalLinker(entity);
                    var url = linker.url + id;
                    var html = linker.html;
                    var options = {
                        type: 'DELETE',
                        url: url,
                        dataType: 'json',
                        success: function (data, textStatus) {
                            gridRefresh();
                        }
                    };
                    $.ajax(options);
                }
            }
            function gridRefresh() {
                var grid = $("#grid").data("kendoGrid");
                grid.dataSource.read();
            }
        </script>
    </body>
</html>
