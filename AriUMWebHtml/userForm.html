<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>AriUM Scaffolding</title>
        <!-- Bootstrap styles -->
        <link href="Content/bootstrap.min.css" rel="stylesheet" media="screen" />
        <!-- Kendo styles -->
        <link href="Content/kendo/2012.3.1114/kendo.common.min.css" rel="stylesheet" />
        <link href="Content/kendo/2012.3.1114/kendo.bootstrap.min.css" rel="stylesheet" />
        <!-- Ariadna styles -->
        <link href="Content/ariadna.css" rel="stylesheet" />

        <!-- JQuery -->
        <script src="Scripts/kendo/2012.3.1114/jquery.min.js"></script>
        <!-- Bootstrap -->
        <script src="Scripts/bootstrap.min.js"></script>
        <!-- Bootbox -->
        <script src="Scripts/bootbox.js"></script>
        <!-- Kendo -->
        <script src="Scripts/kendo/2012.3.1114/kendo.web.min.js"></script>
        <script src="Scripts/kendo/2012.3.1114/cultures/kendo.culture.es-ES.min.js"></script>
        <!-- Ariadna  -->
        <script src="Scripts/ariadna/ariadna.um.js"></script>
        <script src="Scripts/ariadna/ariadna.localization.es-ES.js"></script>
        <!-- Configuration via JSON -->
        <script src="config.js"></script>
    </head>
    <body>
        <header id="cabecera">
        </header>
        <div id="cuerpo" style="min-height:400px;">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <h3>Usuario</h3>
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span2">
                        <label for="txtId">ID</label>
                        <input class="span12 k-text" type="text" name="Id" id="txtId" readonly="true" />
                    </div>
                    <div class="span10">
                        <label for="txtName">Nombre</label>
                        <input class="span12 k-text" type="text" name="Name" id="txtName" required 
                               data-required-msg="Se necesita un nombre" />
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span2"></div>
                    <div class="span10">
                        <label for="txtEmail">Correo electrónico</label>
                        <input class="span12 k-text" type="email" name="Email" id="txtEmail" required 
                            data-required-msg="Se necesita un correo" 
                            data-email-msg="Dirección incorrecta" />
                    </div>
                </div>
                <div class="row-fluid" style="margin-bottom:10px;">
                    <div class="span2"></div>
                    <div class="span10">
                        <label for="cmbUserGroup">Grupo</label>
                        <input name="UserGroup" id="cmbUserGroup" style="width:inherit" />
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span2"></div>
                    <div class="span10">
                        <label for="txtPassword1">Contraseña</label>
                        <input class="span12 k-text" type="password" name="Password1" id="txtPassword1" />
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span2"></div>
                    <div class="span10">
                        <label for="txtPassword2">Repita la contraseña</label>
                        <input class="span12 k-text" type="password" name="Password2" id="txtPassword2" />
                    </div>
                </div>

                <div class="row-fluid">
                    <div class="pull-right">
                        <button id="accept" class="btn btn-primary" title="Guardar cambios">
                            <i class="icon-ok icon-white"></i>
                        </button>
                        <a id="cancel" href="userGrid.html" class="btn btn-primary" title="Salir">
                            <i class="icon-arrow-left icon-white"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <footer id="pie">
        </footer>
        <!-- General form treatment -->
        <script type="text/javascript">
            (function ($) {
                $(document).ready(function () {
                    cargaCabeceraPie();
                    // set title
                    document.title = "Usuario";
                    // culture Spanish - Spain
                    kendo.culture("es-ES");
                    // cheking url parameters
                    var userId = gup("UserId");
                    // is new?
                    var isNew = true;
                    // load combo box
                    $("#cmbUserGroup").kendoComboBox({
                        dataTextField: "Name",
                        dataValueField: "UserGroupId",
                        dataSource: userGroupDS
                    }).data("kendoComboBox");

                    if (userId != "") {
                        isNew = false;
                        getData(userId);
                    }
                    // focus in the first field
                    $("#txtName").focus();
                    // accept button
                    $("#accept").click(function () {
                        // set validator
                        var validator = $("#cuerpo").kendoValidator().data("kendoValidator");
                        if (!okData()) return;
                        if (validator.validate()) {
                            var user = unloadData();
                            setData(user, isNew);
                        }
                    });
                });
            })(jQuery);
        </script>
        <!-- Auxiliary data and functions -->
        <script type="text/javascript">
            var userGroups;
            var userGroupDS = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: controller_url.userGroups + "?order=name",
                        dataType: "json",
                        type: "GET",
                        contentType: "application/json"
                    },
                    parameterMap: function (data, type) {
                        if (type != "GET")
                            return kendo.stringify(data);
                    }
                },
                schema: {
                    model: {
                        id: "UserGroupId",
                        fields: {
                            UserGroupId: { type: "number", editable: false },
                            Name: { type: "string", editable: true, nullable: true, validation: { required: true, message: { required: "Campo requerido" } } }
                        }
                    }
                },
            });
        </script>
        <!-- Specific form treatment -->
        <script type="text/javascript">
            // auxiliary validation
            function okData() {
                var res = true;
                // Pass 1
                var pass1 = $("#txtPassword1").val();
                var pass2 = $("#txtPassword2").val();
                if (pass1 != "" || pass2 != "") {
                    if (pass1 != pass2) {
                        var message = "<h4 class='text-warning'>AVISO:</h4>" +
                          "<p classs='text-warning'> Las contraseñas no coinciden</p>";
                        bootbox.alert(message, "Aceptar");
                        res = false;
                    }
                }
                return res;
            }
            // get data from server
            function getData(userId) {
                var url = controller_url.users + userId;
                var options = {
                    type: 'GET',
                    url: url,
                    dataType: 'json',
                    success: function (data, textStatus) {
                        loadData(data);
                    }
                };
                $.ajax(options);
            }
            // load data into form
            function loadData(user) {
                $("#txtId").val(user.UserId);
                $("#txtName").val(user.Name);
                $("#txtEmail").val(user.Email);
                if (user.UserGroup != null)
                    $("#cmbUserGroup").data("kendoComboBox").value(user.UserGroup.UserGroupId);
                $("#txtPassword1").val(user.Password);
                $("#txtPassword2").val(user.Password);
            }
            // send data to server
            function setData(user, isNew) {
                var url = controller_url.users;
                var type = "";
                var returnUrl = "";
                if (isNew) {
                    type = "POST";
                    returnUrl = "userGrid.html?page=0";
                }
                else {
                    type = "PUT";
                    url = url + user.UserId;
                    returnUrl = "userGrid.html?page=" + gup("page");
                }
                var options = {
                    type: type,
                    url: url,
                    dataType: 'json',
                    data: user,
                    success: function (data, textStatus) {
                        ari_windowOpen(returnUrl);
                    }
                };
                $.ajax(options);
            }
            // unload form data
            function unloadData() {
                var user = new Object();
                user.UserId = $("#txtId").val();
                user.Name = $("#txtName").val();
                user.Email = $("#txtEmail").val();
                var v = $("#cmbUserGroup").data("kendoComboBox").value();
                var t = $("#cmbUserGroup").data("kendoComboBox").text();
                if (v != "") {
                    user.UserGroup = new Object();
                    user.UserGroup.UserGroupId = parseInt(v);
                    user.UserGroup.Name = t;
                }
                var p = $("#txtPassword1").val();
                if (p != "") {
                    user.Password = p;
                }
                return user;
            }
        </script>
    </body>
</html>
