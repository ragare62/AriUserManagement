<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>AriUM Scaffolding</title>
        <!-- Bootstrap styles -->
        <link href="Content/bootstrap.min.css" rel="stylesheet" media="screen" />
        <!-- Kendo styles -->
        <link href="Content/kendo/2012.3.1114/kendo.common.min.css" rel="stylesheet" />
        <link href="Content/kendo/2012.3.1114/kendo.bootstrap.min.css" rel="stylesheet" />
        <!-- Ariadna styles -->
        <link href="Content/ariadna.css" rel="stylesheet" />

        <!-- JQuery -->
        <script src="Scripts/kendo/2012.3.1114/jquery.min.js"></script>
        <!-- Bootstrap -->
        <script src="Scripts/bootstrap.min.js"></script>
        <!-- Bootbox -->
        <script src="Scripts/bootbox.js"></script>
        <!-- Kendo -->
        <script src="Scripts/kendo/2012.3.1114/kendo.web.js"></script>
        <script src="Scripts/kendo/2012.3.1114/cultures/kendo.culture.es-ES.min.js"></script>
        <!-- Ariadna  -->
        <script src="Scripts/ariadna/ariadna.um.js"></script>
        <script src="Scripts/ariadna/ariadna.localization.es-ES.js"></script>
        <!-- Configuration via JSON -->
        <script src="config.js"></script>
    </head>
    <body>
        <header id="header">
        </header>

        <div id="cuerpo" style="min-height:400px;">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <h3>Usuarios</h3>
                    </div>
                </div>
                <div class="row-fluid">
                    <div id="gridUser" class="span12"></div>
                </div>
                <div class="row-fluid">
                    <div id="formUser" class="span12">
                        <div class="row-fluid">
                            <div class="span2">
                                <label for="txtId">ID</label>
                                <input class="span12 k-text" type="text" name="Id" id="txtId" readonly="true" />
                            </div>
                            <div class="span10">
                                <label for="txtName">Nombre</label>
                                <input class="span12 k-text" type="text" name="Name" id="txtName" required 
                                       data-required-msg="Se necesita un nombre" />
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span2"></div>
                            <div class="span10">
                                <label for="txtEmail">Correo electrónico</label>
                                <input class="span12 k-text" type="email" name="Email" id="txtEmail" required 
                                       data-required-msg="Se necesita un correo" 
                                       data-email-msg="Dirección incorrecta" />
                            </div>
                        </div>
                        <div class="row-fluid"  style="margin-bottom:10px;">
                            <div class="span2"></div>
                            <div class="span10">
                                <label for="txtUserGroup">Grupo</label>
                                <input name="UserGroup" id="txtUserGroup" style="width:inherit;"/>
                                <button id="sUserGroup" class="btn-primary" title="Buscar grupos" onclick="formUserSearch('UserGroup');">
                                    <i class="icon-search icon-white"></i>
                                </button>
                                <input type="hidden" id="txtUserGroupId" />
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span2"></div>
                            <div class="span10">
                                <label for="txtPassword1">Contraseña</label>
                                <input class="span12 k-text" type="password" name="Password1" id="txtPassword1" />
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span2"></div>
                            <div class="span10">
                                <label for="txtPassword2">Repita la contraseña</label>
                                <input class="span12 k-text" type="password" name="Password2" id="txtPassword2" />
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div id="searchWindow" class="span12"></div>
                        </div>
                        <div class="row-fluid">
                            <div class="pull-right">
                                <button id="accept" class="btn btn-primary" onclick="formUserAccept();" title="Guardar cambios">
                                    <i class="icon-ok icon-white"></i>
                                </button>
                                <button id="cancel" class="btn btn-primary" onclick="formUserCancel();" title="Salir">
                                    <i class="icon-arrow-left icon-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer id="footer">
        </footer>

        <!-- Templates -->
        <script type="text/x-kendo-template" id="tNewUser">
            <button class="btn btn-primary" onclick="formUserNew();" title="Nuevo registro">
                <i class="icon-plus icon-white"></i>
            </button>
        </script>
        <script type="tex/x-kendo-template" id="tEditUser">
            <div class="pull-right">
                <button class="btn btn-primary" onclick="formUserEdit(#=UserId#);" title="Editar registro">
                    <i class="icon-pencil icon-white"></i>
                </button>
                <button class="btn btn-primary" onclick="gridUserDelete(#=UserId#,'#=Name#');" title="Eliminar registro">
                    <i class="icon-minus icon-white"></i>
                </button>
            </div>
        </script>
        <script type="tex/x-kendo-template" id="tEditUserS">
            <div class="pull-right">
                <button class="btn btn-primary" onclick="gridUserSelect(#=UserId#);" title="Seleccionar registro">
                    <i class="icon-share icon-white"></i>
                </button>
            </div>
        </script>
        <script type="text/javascript">
            (function ($) {
                $(document).ready(function () {
                    //
                    loadDefaults();
                    if (mode != "S")
                        loadHeaderFooter();
                    // set title
                    document.title = "Usuarios";
                    // 
                    showgridUser();
            
                    // building gridUser
                    $("#gridUser").kendoGrid({
                        dataSource: gridUserDS,
                        columns: gridUserCL,
                        toolbar: [{template: t_new }],
                        pageable: ari_pageable_es_ES,
                        sortable: true,
                        groupable: ari_groupable_es_ES,
                        filterable: ari_filterable_es_ES,
                        columnMenu: ari_columnMenu_es_ES
                    });
            
                    // building autocomplete
                    $("#txtUserGroup").kendoAutoComplete({
                        dataTextField: "Name",
                        dataSource: userGroupDS,
                        select: function (e) {
                            var dataItem = this.dataItem(e.item.index());
                            $("#txtUserGroupId").val(dataItem.UserGroupId);
                        }
                    });

                    // building search windows
                    // building search windows
                    wUserGroup = $("#searchWindow").kendoWindow({
                        visible: false,
                        title: "Buscar grupo",
                        content: "UserGroup.html"
                    });
                });
            })(jQuery);
        </script>
        <script type="text/javascript">
            /*
            ---------------------------------------
            General variables 
            ---------------------------------------
            */
            var isNew = false; //
            var deleteId = 0;
            // Load url parameters
            var mode = gup("mode");
            // check if is called from inside another page
            var ref = window.parent.location.href;
            var b = ref.search("User.html")
            if (b < 0)
                mode = "S"; 
            var wUserGroup;
        </script>
        <script type="text/javascript">
            /*
            ---------------------------------------
            gridUser related fields
            ---------------------------------------
            */
            
            // Load templates
            var t_new = kendo.template($("#tNewUser").html());
            var t_edit = kendo.template($("#tEditUser").html());
            if (mode == "S")
                t_edit = kendo.template($("#tEditUserS").html());
            
            // gridUser datasource
            var gridUserDS = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: controller_url.Users,
                        dataType: "json",
                        type: "GET",
                        contentType: "application/json"
                    },
                    parameterMap: function (data, type) {
                        if (type != "GET")
                            return kendo.stringify(data);
                    }
                },
                schema: {
                    model: {
                        id: "UserId",
                        fields: {
                            UserId: { type: "number" },
                            Name: { type: "string" },
                            Email: { type: "string" },
                            Password: { type: "string" },
                            UserGroup: {}
                        }
                    }
                },
                pageSize: 5
            });
            // gridUser columns
            var gridUserCL = [
                { field: "UserId", title: "ID" },
                { field: "Name", title: "Nombre" },
                { field: "Email", title: "Correo" },
                { field: "UserGroup", title: "Grupo", template: "#=UserGroup?UserGroup.Name:''#" },{
                    template: t_edit
                }
            ];
            // DataSource for UserGroup autocomplete
            var userGroupDS = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: controller_url.UserGroups + "?order=name",
                        dataType: "json",
                        type: "GET",
                        contentType: "application/json",
                        silverFiltering: true,
                        serverPaging: true
                    },
                    parameterMap: function (data, type) {
                        if (type != "GET")
                            return kendo.stringify(data);
                    }
                },
                schema: {
                    model: {
                        id: "UserGroupId",
                        fields: {
                            UserGroupId: { type: "number" },
                            Name: { type: "string" }
                        }
                    }
                },
            });
        </script>
        <script type="text/javascript">
            /*
            ---------------------------------------
            gridUser management functions
            ---------------------------------------
            */
            function gridUserRefresh() {
                var ds = $("#gridUser").data("kendoGrid").dataSource;
                ds.read();
                if (isNew) {
                    var totalPages = ds.totalPages();
                    ds.page(totalPages);
                }
            }
            function gridUserDelete(id, name) {
                deleteId = id;
                bootbox.confirm("<h4>¿Desea eliminar este registro? (" + name + ")</h4>", "Cancelar", "Aceptar", deleteResponse);
            }
            function deleteResponse(arg) {
                if (arg) {
                    var url = controller_url.Users + deleteId;
                    var options = {
                        type: 'DELETE',
                        url: url,
                        dataType: 'json',
                        success: function (data, textStatus) {
                            gridUserRefresh();
                        }
                    };
                    $.ajax(options);
                }
            }
        </script>
        <script type="text/javascript">
            /*
            -----------------------------------------
            General page function
            -----------------------------------------
            */
            // Show the gridUser div and hides the formUser one
            function showgridUser() {
                $("#gridUser").show();
                $("#formUser").hide();
            }
            // shows the formUser div and hides the gridUser one
            function showformUser() {
                $("#formUser").show();
                $("#gridUser").hide();
            }
        </script>
        <script type="text/javascript">
            /*
            ---------------------------------------
            formUser management functions
            ---------------------------------------
            */
            function formUserNew() {
                isNew = true;
                $("#txtId").val("");
                $("#txtName").val("");
                $("#txtEmail").val("");
                $("#txtUserGroup").val("");
                showformUser();
                $("#txtName").focus();
            }
            function formUserEdit(id) {
                isNew = false;
                var url = controller_url.Users + id;
                var options = {
                    type: 'GET',
                    url: url,
                    dataType: 'json',
                    success: function (data, textStatus) {
                        formUserLoadData(data);
                        showformUser();
                        $("#txtName").focus();
                    }
                };
                $.ajax(options);
            }
            function formUserAccept() {
                var validator = $("#formUser").kendoValidator().data("kendoValidator");
                if (!formUserDataOk())
                    return;
                if (validator.validate()) {
                    var User = formUserUnloadData();
                    var url = controller_url.Users;
                    var type = "";
                    if (isNew)
                        type = "POST";
                    else {
                        type = "PUT";
                        url += User.UserId;
                    }
                    var options = {
                        type: type,
                        url: url,
                        dataType: 'json',
                        data: User,
                        success: function (data, textStatus) {
                            gridUserRefresh();
                            showgridUser();
                        }
                    }
                    $.ajax(options);
                }
            }
            function formUserCancel() {
                showgridUser();
            }
            function formUserUnloadData() {
                var User = new Object();
                User.UserId = $("#txtId").val();
                User.Name = $("#txtName").val();
                User.Email = $("#txtEmail").val();
                var v = $("#txtUserGroupId").val();
                var t = $("#txtUserGroup").val();
                if (v != "" && t != "") {
                    User.UserGroup = new Object();
                    User.UserGroup.UserGroupId = parseInt(v);
                    User.UserGroup.Name = t;
                }
                var p = $("#txtPassword1").val();
                if (p != "") {
                    User.Password = p;
                }
                return User;
            }
            function formUserLoadData(User) {
                $("#txtId").val(User.UserId);
                $("#txtName").val(User.Name);
                $("#txtEmail").val(User.Email);
                if (User.UserGroup != null) {
                    $("#txtUserGroup").val(User.UserGroup.Name);
                    $("#txtUserGroupId").val(User.UserGroup.UserGroupId);
                }
                $("#txtPassword1").val(User.Password);
                $("#txtPassword2").val(User.Password);
            }
            function formUserDataOk() {
                var pass1 = $("#txtPassword1").val();
                var pass2 = $("#txtPassword2").val();
                if (pass1 != "" || pass2 != "") {
                    if (pass1 != pass2) {
                        var message = "<h4 class='text-warning'>AVISO:</h4>" +
                                      "<p classs='text-warning'> Las contraseñas no coinciden</p>";
                        bootbox.alert(message, "Aceptar");
                        return false;
                    }
                }
                return true;
            }
            function formUserSearch(entity) {
                switch (entity) {
                    case "UserGroup":
                        wUserGroup.data("kendoWindow").open();
                        break;
                }
            }
        </script>
    </body>
</html>
